---
title: "Questionnaire Data Backward Mask Task"
output:
  html_document: 
    fig_height: 12
    fig_caption: yes
    fig_width: 8
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Import Library

```{r}
library(readxl)
library(rstatix)
library(ggplot2)
library(apaTables)
library(ez)
library(dplyr)
library(tidyr)
library(car)
library(emmeans)
library(ggplot2)
```

# Import Dataset

```{r}
#"C:/Users/juhoffmann/Desktop/Git/UnconsciousBias/data/BackwardMask_Questionnaire_Results.xlsx
#/Users/julia/Desktop/Git/EEGfMRIStudy/UnconsciousBias/data/
data <- read_excel("C:/Users/juhoffmann/Desktop/Git/UnconsciousBias/data/BackwardMask_Questionnaire_Results.xlsx", 
                 col_types = c("text", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", "numeric",  
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "text", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric"), na = "na")

head(data)
```

# FB Analysis

## Rename Questionnaires

```{r}

data <- data

colnames(data)[colnames(data) == "BDI-II Sum score"] ="BDI"
colnames(data)[colnames(data) == "BVAQ_New"] ="BVAQ"
colnames(data)[colnames(data) == "WMS Correct"] ="WMS"
colnames(data)[colnames(data) == "TM A"] ="TMT_A"
colnames(data)[colnames(data) == "TM B"] ="TMT_B"

colnames(data)[colnames(data) == "DERS_Gesamtwert"] ="DERS_sum_score"
colnames(data)[colnames(data) == "DERS_Nicht-Akzeptanz emotionalerReaktionen"] ="DERS_non_acceptance"
colnames(data)[colnames(data) == "DERS_Probleme mit zielorientiertem Verhalten"] ="DERS_goals"
colnames(data)[colnames(data) == "DERS_Impulskontrollprobleme"] ="DERS_impulse"
colnames(data)[colnames(data) == "DERS_Mangel an emotionaler Aufmerksamkeit"] ="DERS_awareness"
colnames(data)[colnames(data) == "DERS_EingeschrÃ¤nkter Zugang zu Emotionsregulations-Strategien"] ="DERS_strategies"
colnames(data)[colnames(data) == "DERS_Mangel an emotionaler Klarheit"] ="DERS_clarity"

colnames(data)[colnames(data) == "CERQ_Selbstbeschuldigung"] ="CERQ_self_blame"
colnames(data)[colnames(data) == "CERQ_Akzeptanz"] ="CERQ_acceptance"
colnames(data)[colnames(data) == "CERQ_Rumination"] ="CERQ_rumination"
colnames(data)[colnames(data) == "CERQ_Positive Refokussierung"] ="CERQ_positive_reinforcement"
colnames(data)[colnames(data) == "CERQ_Refokussierung auf Planung"] ="CERQ_refocus_on_planning"
colnames(data)[colnames(data) == "CERQ_Positive Neubewertung"] ="CERQ_positive_reappraisal"
colnames(data)[colnames(data) == "CERQ_Relativieren"] ="CERQ_putting_into_perspective"
colnames(data)[colnames(data) == "CERQ_Katastrophisierung"] ="CERQ_catastrophizing"
colnames(data)[colnames(data) == "CERQ_Andere Beschuldigen"] ="CERQ_blaming_others"

colnames(data)[colnames(data) == "Hamilton Score"] ="Hamilton_Score"

colnames(data)[colnames(data) == "DigitSpan_Forwards_Span"] ="Digit_forward_span"
colnames(data)[colnames(data) == "DigitSpan_ForwardsTotal Score"] ="Digit_forward_score"
colnames(data)[colnames(data) == "DigitSpan_Backwards_Span"] ="Digit_backward_span"
colnames(data)[colnames(data) == "DigitSpan_Backwards_Total Score"] ="Digit_backward_score"
```

## look at dataset

```{r}
tibble(data)
```

## take only columns i need

# Transform data

```{r}

d_FB <- data[c('Group_MDD1_HC2', "BVAQ", "WMS", "TMT_A", "TMT_B", "STAI1", "STAI2",
             "DERS_sum_score", "DERS_non_acceptance", "DERS_goals", "DERS_impulse", "DERS_awareness", "DERS_strategies", "DERS_clarity",
             "CERQ_self_blame", "CERQ_acceptance", "CERQ_rumination", "CERQ_positive_reinforcement", "CERQ_refocus_on_planning",
             "CERQ_positive_reappraisal", "CERQ_putting_into_perspective", "CERQ_catastrophizing", "CERQ_blaming_others",
              "Digit_forward_score", "Digit_backward_score")]
```

## remove rows with missing values

```{r}
# Remove NA values from the dataset
data_FB_clean <- na.omit(d_FB)

# Check the dimensions of the cleaned dataset
dim(data_FB_clean)

# Use the cleaned dataset for further analysis

```

# Perform MANOVA

If you have multiple questionnaires and want to compare the sum scores between two groups while controlling for multiple comparisons, you can use a multivariate approach such as a multivariate analysis of variance (MANOVA) or a permutation-based approach.

```{r}
# Assuming 'manova_out' is the result object from your MANOVA analysis
manova_out <- manova(cbind(BVAQ, WMS, TMT_A, TMT_B, STAI1, STAI2,
                           DERS_sum_score, DERS_non_acceptance, DERS_goals, DERS_impulse, DERS_awareness, DERS_strategies, DERS_clarity,
                           CERQ_self_blame, CERQ_acceptance, CERQ_rumination, CERQ_positive_reinforcement, CERQ_refocus_on_planning,
                           CERQ_positive_reappraisal, CERQ_putting_into_perspective, CERQ_catastrophizing, CERQ_blaming_others,
                           Digit_forward_score, Digit_backward_score) 
                     ~ Group_MDD1_HC2,
                     data = data_FB_clean)
summary(manova_out, tol=0)

# Extract the dependent variable names
dependent_vars <- c("BVAQ", "WMS", "TMT_A", "TMT_B", "STAI1", "STAI2",
                    "DERS_sum_score","DERS_non_acceptance","DERS_goals","DERS_impulse","DERS_awareness","DERS_strategies","DERS_clarity",
                    "CERQ_self_blame", "CERQ_acceptance", "CERQ_rumination", "CERQ_positive_reinforcement", "CERQ_refocus_on_planning",
                    "CERQ_positive_reappraisal", "CERQ_putting_into_perspective", "CERQ_catastrophizing", "CERQ_blaming_others",
                    "Digit_forward_score","Digit_backward_score")

```


```{r}
library(dplyr)

data <- data_FB_clean

# Function to calculate Cohen's d
cohens_d <- function(group1, group2) {
  n1 <- length(group1)
  n2 <- length(group2)
  sd1 <- sd(group1)
  sd2 <- sd(group2)
  pooled_sd <- sqrt(((n1 - 1) * sd1^2 + (n2 - 1) * sd2^2) / (n1 + n2 - 2))
  if(pooled_sd == 0) { # Avoid division by zero
    return(NA)
  }
  d <- (mean(group1) - mean(group2)) / pooled_sd
  return(d)
}

# Function to calculate Standard Error (SE)
calculate_se <- function(group1, group2) {
  n1 <- length(group1)
  n2 <- length(group2)
  sd1 <- sd(group1)
  sd2 <- sd(group2)
  se <- sqrt(sd1^2 / n1 + sd2^2 / n2)
  return(se)
}

# Specify the questionnaire variables you want to analyze
variables <- c("BVAQ", "WMS", "TMT_A", "TMT_B", "STAI1", "STAI2",
               "DERS_sum_score", "DERS_non_acceptance", "DERS_goals", "DERS_impulse", "DERS_awareness", "DERS_strategies",
               "DERS_clarity","CERQ_self_blame", "CERQ_acceptance", "CERQ_rumination", "CERQ_positive_reinforcement",
               "CERQ_refocus_on_planning","CERQ_positive_reappraisal", "CERQ_putting_into_perspective", "CERQ_catastrophizing",
               "CERQ_blaming_others", "Digit_forward_score", "Digit_backward_score")

# Perform calculations
results <- lapply(variables, function(var) {
  group1 <- data %>% filter(Group_MDD1_HC2 == 1) %>% pull(!!sym(var))
  group2 <- data %>% filter(Group_MDD1_HC2 == 2) %>% pull(!!sym(var))
  t_test_result <- t.test(group1, group2, paired = FALSE, var.equal = FALSE)
  
  cohens_d_value <- cohens_d(group1, group2)
  se <- calculate_se(group1, group2)
  df <- t_test_result$parameter
  
  data.frame(
    Variable = var,
    P_Value = t_test_result$p.value,
    T_Value = unname(t_test_result$statistic),
    df = df,
    Cohens_D = cohens_d_value,
    SE = se
  )
}) %>% bind_rows()


# Round numeric columns to 5 decimal places
results <- results %>%
  mutate(across(c(SE,P_Value), ~round(., 5)))

# Display the results
print(results)
#/Users/julia/Desktop/Git/EEGfMRIStudy/UnconsciousBias/data/
write.csv(results, "W:/Fmri_Forschung/Allerlei/JuliaS/GitHub/UnconsciousBias/data/Group_Comparison_Questionnaires.csv", row.names = FALSE)
```

# Plot data

```{r}
data_FB_clean <- data_FB_clean %>%
  mutate(Group_MDD1_HC2 = as.factor(Group_MDD1_HC2))

#Reshape the data into long format 
d_FB_long <- data_FB_clean %>% gather(variable, value, -Group_MDD1_HC2)
```

```{r fig.width=11,fig.height=17}
# Create violin plots

ggplot(d_FB_long, aes(x = variable, y = value, fill = Group_MDD1_HC2)) +
  geom_violin(pattern = c("22", " ", " ")) +
  scale_fill_manual(values = c("gray", "white")) +
  facet_wrap(~variable, scales = "free", ncol = 4) +
  labs(x = "Variable", y = "Value") +
  theme_bw()
```

# Plot BDI

```{r}
#C:/Users/juhoffmann/Desktop/Git/UnconsciousBias/data/
#/Users/julia/Desktop/Git/EEGfMRIStudy/UnconsciousBias/data/
data <- read_excel("C:/Users/juhoffmann/Desktop/Git/UnconsciousBias/data/BackwardMask_Questionnaire_Results.xlsx", 
                 col_types = c("text", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", "numeric",  
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "text", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric"), na = "na")

colnames(data)[colnames(data) == "BDI-II Sum score"] ="BDI"

d_BDI <- data[c('Group_MDD1_HC2', "BDI")]
d_BDI <- na.omit(d_BDI)
d_BDI <- d_BDI %>%
  mutate(Group_MDD1_HC2 = as.factor(Group_MDD1_HC2))

```

```{r fig.width=2,fig.height=3}
# Create the violin plot

ggplot(d_BDI, aes(x = Group_MDD1_HC2, y = BDI, fill = Group_MDD1_HC2)) +
  geom_violin(data = subset(d_BDI, Group_MDD1_HC2 == "1"), fill = "grey") +
  geom_violin(data = subset(d_BDI, Group_MDD1_HC2 == "2"), fill = "white") +
  labs(x = "Group_MDD1_HC2", y = "BDI") +
  theme_bw()
```

```{r}
# Perform t-test
pairwise_results <- t.test(d_BDI$BDI ~ d_BDI$Group_MDD1_HC2, paired = FALSE)
print(pairwise_results)
```


# Apply Bonferroni correction

```{r}
p_values <- c(0.0000100,
0.4820100,
0.0552000,
0.9226300,
0.0000000,
0.0000000,
0.0000000,
0.0000000,
0.0000000,
0.0000000,
0.0000000,
0.0000000,
0.0000000,
0.0000000,
0.8694800,
0.0000500,
0.0000000,
0.0000200,
0.0000000,
0.0000000,
0.0000000,
0.0389700,
0.6748300,
0.4972800,
0.0000000
)

# Number of comparisons
n_comparisons <- length(p_values)

# Bonferroni correction
bonferroni_corrected <- p_values * n_comparisons

# Cap the corrected p-values at 1
bonferroni_corrected <- pmin(bonferroni_corrected, 1)

# Print the corrected p-values
print(bonferroni_corrected)

```


---
title: "ER_Groupanalysis"
output: html_notebook
---

Import libraries

```{r}
library(readxl)
library(rstatix)
library(ggplot2)
library(apaTables)
library(ez)
library(dplyr)
library(tidyr)
library(car)
library(emmeans)
library(ggplot2)
```

Import dataset

```{r}
data <- read_excel("C:/Users/juhoffmann/Desktop/Git/UnconsciousBias/data/BackwardMask_Questionnaire_Results_CERQ.xlsx", 
     col_types = c("text", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric", "numeric", "numeric", 
         "numeric"))
```

Rename columns

```{r}
data <- data

colnames(data)[colnames(data) == "name"] ="participant"
colnames(data)[colnames(data) == "Alter"] ="age"
colnames(data)[colnames(data) == "Gender_f1_m2"] ="sex"
colnames(data)[colnames(data) == "Group_MDD1_HC2"] ="group"

# functional emotion regulation strategies
colnames(data)[colnames(data) == "CERQ_Relativieren"] ="CERQ_putting_into_perspective"
colnames(data)[colnames(data) == "CERQ_Positive Refokussierung"] ="CERQ_positive_reinforcement"
colnames(data)[colnames(data) == "CERQ_Positive Neubewertung"] ="CERQ_positive_reappraisal"
colnames(data)[colnames(data) == "CERQ_Refokussierung auf Planung"] ="CERQ_refocus_on_planning"
colnames(data)[colnames(data) == "CERQ_Akzeptanz"] ="CERQ_acceptance"
# dysfunctional emotion regulation strategies
colnames(data)[colnames(data) == "CERQ_Selbstbeschuldigung"] ="CERQ_self_blame"
colnames(data)[colnames(data) == "CERQ_Rumination"] ="CERQ_rumination"
colnames(data)[colnames(data) == "CERQ_Katastrophisierung"] ="CERQ_catastrophizing"
colnames(data)[colnames(data) == "CERQ_Andere Beschuldigen"] ="CERQ_blaming_others"
```

```{r}
data$functional_score = rowMeans(data[, c("CERQ_putting_into_perspective", "CERQ_positive_reinforcement",  "CERQ_positive_reappraisal", "CERQ_refocus_on_planning", "CERQ_acceptance")], na.rm = TRUE)
data$dysfunctional_score = rowMeans(data[, c("CERQ_self_blame", "CERQ_rumination", "CERQ_catastrophizing", "CERQ_blaming_others")], na.rm = TRUE)

```

Median split approach

```{r}
# Identifying median values
median_functional = median(data$functional_score, na.rm = TRUE)
median_dysfunctional = median(data$dysfunctional_score, na.rm = TRUE)

# Sorting participants
data$ERgroup = with(data, ifelse(functional_score >= median_functional & dysfunctional_score < median_dysfunctional, "Functional", 
                               ifelse(functional_score < median_functional & dysfunctional_score >= median_dysfunctional, "Dysfunctional", "Mixed")))

```

```{r}
table(data$group, data$ERgroup)
```

```{r}
library(ggplot2)

# Converting 'group' to a factor for clearer labels in the plot
data$group <- factor(data$group, levels = c(1, 2), labels = c("MDD", "HC"))

ggplot(data, aes(x = ERgroup, fill = group)) + 
  geom_bar(position = "dodge") +
  labs(title = "Distribution of Emotion Regulation Groups",
       x = "Emotion Regulation Group",
       y = "Count",
       fill = "Group") +
  theme_minimal()

```

Statistical tests to see if the distribution across ER groups significantly differs between MDD patients and healthy controls. This will test the null hypothesis that there is no association between the participant group (MDD vs. HC) and their ER group (Dysfunctional, Mixed, Functional)

```{r}
chisq.test(table(data$group, data$ERgroup))
```

# Clustering

Prepare Data: Scale ER strategy scores to ensure they’re on the same scale, which is important for clustering.

```{r}
scores_scaled <- scale(data[, c("CERQ_self_blame", "CERQ_rumination", "CERQ_catastrophizing", "CERQ_blaming_others", "CERQ_putting_into_perspective", "CERQ_positive_reinforcement", "CERQ_positive_reappraisal", "CERQ_refocus_on_planning", "CERQ_acceptance")])

```

Use the NbClust package for determining the number of clusters, which offers a wide range of methods:

```{r}
#install.packages("NbClust")
library(NbClust)
data2 <- scores_scaled  # Assuming this is your prepared data
nb <- NbClust(data2, distance = "euclidean", min.nc = 2, max.nc = 15, method = "kmeans")
```

-> chose 2 Cluster

Apply k-means clustering with the determined number of clusters:

```{r}
set.seed(123)  # for reproducibility
k <- 2  # assuming the optimal number of clusters is 2
kmeans_result <- kmeans(scores_scaled, centers = k, nstart = 25)

```

Add the cluster assignments back to your original dataframe:

```{r}
data$cluster <- kmeans_result$cluster
```

```{r}
table(data$group, data$cluster)
#änderung
```
```{r}

data$group <- factor(data$group, levels = c(1, 2), labels = c("MDD", "HC"))
data$cluster <- factor(data$cluster)
# Create the plot
ggplot(data, aes(x = cluster, fill = group)) +
  geom_bar(position = "dodge") +
  labs(title = "Distribution of MDD and HC Participants Across Clusters",
       x = "Cluster", y = "Number of Participants") +
  scale_fill_brewer(palette = "Set1") +
  theme_minimal()

```

